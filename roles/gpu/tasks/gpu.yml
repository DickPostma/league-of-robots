---
- name: Install yum requirements for gpu driver installation
  ansible.builtin.yum:
    state: 'installed'
    update_cache: true
    name:
      - tar
      - bzip2
      - make
      - automake
      - gcc
      - gcc-c++
      - pciutils
      - elfutils-libelf-devel
      - libglvnd-devel
      - bind-utils
      - wget
  become: true

## ansible_kernel variable is not working, as after reboot, still holds old kernel
#- name: Get current kernel version
#  ansible.builtin.command: '/usr/bin/uname -r'
#  register: uname_output
#  failed_when: uname_output.rc != 0
#  when: true
#  become: true
#
#- name: Set kernel version fact
#  ansible.builtin.set_fact:
#    kernel_version: "{{ uname_output.stdout }}"

- name: Gather facts to get the latest kernel version
  ansible.builtin.setup:
  become: true

- name: Install kernel developement package matching running kernel version
  ansible.builtin.yum:
    name: 'kernel-devel-{{ ansible_kernel }}'
  register: yum_result
  failed_when: yum_result.rc != 0
  when: true
  become: true

- name: Download a driver installation file from NVidia
  ansible.builtin.get_url:
    url: '{{ gpu_url_directory }}/{{ gpu_runfile }}'
    dest: '/root/{{ gpu_runfile }}'
    mode: '0700'
  become: true

- name: Install driver from .run file
  ansible.builtin.command: '/root/{{ gpu_runfile }} --silent --driver'
  register: install_result
  failed_when: install_result.rc != 0
  when: true
  notify: reboot_server
  become: true

- name: Enforce reboot, so that we can check if drivers are correctly isntalled
  ansible.builtin.meta: flush_handlers

- name: Check that drivers are correctly installed
  ansible.builtin.command: 'nvidia-smi -L'
  register: smi_output
  failed_when: (smi_output.rc > 1) or ({{ smi_output | default([]) | length < 1 }})

- name: Remove installation file
  ansible.builtin.file:
    path: '/root/{{ gpu_runfile }}'
    state: absent
  become: true
...
