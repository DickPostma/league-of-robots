#jinja2: trim_blocks:True, lstrip_blocks: True
#!/bin/bash

#
##
### Functions to manage Pulp repos.
##
#

function pulp-sync-publish-distribute() {
	#
	# Configure variables.
	#
	local      _stack_prefix='{{ stack_prefix }}'
	local      _stack_name='{{ stack_name | regex_replace('_cluster$', '') }}'
	declare -a _pulp_repos_with_remotes
	declare -a _all_pulp_repos
	local      _pulp_repo_management_user='{{ repo_management_user }}'
	local      _pulp_repo
	_pulp_repos_with_remotes=(
		{% for pulp_repo in pulp_repos[os_distribution] %}
			{% if pulp_repo['remote_url'] is defined %}
		{{ pulp_repo['name'] }}
			{% endif %}
		{% endfor %}
	)
	_all_pulp_repos=(
		"${_pulp_repos_with_remotes[@]}"
		{% for pulp_repo in pulp_repos[os_distribution] %}
			{% if pulp_repo['remote_url'] is not defined %}
		{{ pulp_repo['name'] }}
			{% endif %}
		{% endfor %}
	)
	{% raw %}
	#
	# Check and modify env.
	#
	local _opt_nounset_was_enbled
	if [[ -o nounset ]]; then
		_opt_nounset_was_enbled='true'
	else
		_opt_nounset_was_enbled='false'
		set -u
	fi
	#
	# Check if Python venv was initialized.
	#
	if [[ -z "${VIRTUAL_ENV:-}" ]]; then
		echo 'ERROR: ${VIRTUAL_ENV} is empty.'
		echo 'FATAL: This code requires the pulp-cli and its dependencies installed in a Python virtual environment.'
		echo '       Try:'
		echo "           source /admin/${_pulp_repo_management_user}/pulp-cli.venv/bin/activate"
		echo '       to load the Python virtual environment.'
		echo 'FATAL: See https://github.com/rug-cit-hpc/league-of-robots/blob/develop/documentation/Configuring_Pulp.md for additional instructions.'
		return 1
	fi
	echo '######################################################################################'
	echo '# Add remotes to repos.'
	echo '######################################################################################'
	for _pulp_repo in "${_pulp_repos_with_remotes[@]}"; do
		echo "INFO: Adding ${_pulp_repo}-remote to ${_pulp_repo} repo..."
		pulp rpm repository update --name "${_pulp_repo}" --remote "${_pulp_repo}-remote"
	done
	echo '######################################################################################'
	echo '# Sync repos with remotes creating new repository versions.'
	echo '######################################################################################'
	for _pulp_repo in "${_pulp_repos_with_remotes[@]}"; do
		echo "INFO: Syncing ${_pulp_repo} repo with remote ..."
		pulp rpm repository sync --name "${_pulp_repo}"
	done
	echo '######################################################################################'
	echo '# Create/update distributions based on publications using latest repository versions.'
	echo '######################################################################################'
	for _pulp_repo in "${_all_pulp_repos[@]}"; do
		echo "INFO: Processing distribution name ${_stack_prefix}-${_pulp_repo} with base path ${_stack_name}/${_pulp_repo} ..."
		#
		# Get latest repository version href for this repo.
		#
		local _latest_version_href=$(pulp --format json rpm repository show --name "${_pulp_repo}" | jq -r '.latest_version_href')
		#
		# Check if we already have a publication for the latest repository version.
		#
		local _publication_href
		if [[ $(pulp --format json rpm publication list --repository-version "${_latest_version_href}" 2>/dev/null \
				| jq -r 'first.pulp_href') =~ /pulp/api/ ]]; then
			echo "INFO:    Using existing publication for latest version of ${_pulp_repo} repository ..."
			_publication_href=$(pulp --format json \
				rpm publication list --repository-version "${_latest_version_href}" \
				| jq -r 'first.pulp_href')
		else
			echo "INFO:    Creating new publication for latest version of ${_pulp_repo} repository ..."
			_publication_href=$(pulp --format json \
				rpm publication create --repository "${_pulp_repo}" \
				| jq -r '.pulp_href')
		fi
		#
		# Check if we already have a distribution for this repo.
		#
		local _distribution_action
		if pulp rpm distribution show --name "${_stack_prefix}-${_pulp_repo}" >/dev/null 2>&1; then
			_distribution_action='update'
			echo "INFO:    Updating distribution ..."
		else
			_distribution_action='create'
			echo "INFO:    Creating distribution ..."
		fi
		pulp rpm distribution "${_distribution_action}" \
			--name "${_stack_prefix}-${_pulp_repo}" \
			--base-path "${_stack_name}/${_pulp_repo}" \
			--publication "${_publication_href}"
		echo '============================================================================'
	done
	#
	# Reset env.
	#
	if [[ "${_opt_nounset_was_enbled}" == 'false' ]]; then
		set +u
	fi
}

echo 'INFO: Added "pulp-sync-publish-distribute" function/command to environment.'

{% endraw %}
