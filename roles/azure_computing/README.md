# Azure compute

## Intro

This is one of three Azure roles
 - `azure_general` role creates Azure group which contains the network, VMs, network interfaces, security groups. This helps with an overview of used and available Azure resources
 - `azure_networking` role defines and mnages the entire stack of network: networks, sub-networks and security groups within the individual Azure group
 - `azure_computing` role defines and manages the VMs, their storage, network interfaces, public IP and private IPs inside the invididual Azure group

## Group variables

THE most important variable is the `azure_flavor`. This one triggers the generation of VMs. Of course the group variables must also contain the `azure_image` and `azure_networks`.

Define host in static inventory

```
    jumphost:
      hosts:
        testmachine:
          azure_flavor: Standard_DS1_v2
          host_networks:
            - name: logs-vnet
```

also define in the `group_vars/[stack_name]/vars.yml`

```
azure_resource_group: "{{ stack_name }}"
azure_networks:
  - name: "{{ stack_prefix }}_internal_management"
    external: false
    cidr: '10.10.1.0/24'
    type: management
azure_image:
  rocky9:
    offer: 'rockylinux-x86_64'
    publisher: 'resf'
    sku: '9-base'
    version: 'latest'
```

Where

 - `azure_resource_group` defines a Azure group
 - `azure_networks` defines one or more networks of the current azure environment (does not support MTUs)
 - `azure_image` is a bit tricky, since user must find (preferably via azure cli) all four fields of this variable

After you have defined all the variables, you
(make sure you have initialized `lor-init` and done `lor-config`, then simply run

```
    ansible-playbook azure.yml
```

The playbook should create the entire stack (network, VMs, network interfaces, security groups) and generate the the `group_vars/[stack_name]/` files

 - `ip_addresses.yml.new`, and
 - `ssh_client_settings.yml.new`

Make sure you don't overwrite the values of openstack generated or manually generated IPs! Keep/update only the values that were generated by Ansible Azure roles of `azure_general`, `azure_compute` and `azure_network`.

## Instances physical location

The default `azure_location` is set to `westeurope` - and is defined in

 - `group_vars/all/vars.yml` as well as in
 - `defaults/main.yml` of all three roles (`azure_computing`, `azure_general` and `azure_networking`)

## Extra information

https://docs.ansible.com/ansible/4/scenario_guides/guide_azure.html
