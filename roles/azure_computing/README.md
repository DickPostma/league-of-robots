# Azure compute

## Intro

This is one of three Azure roles

 - [azure_general](../azure_general/README.md) role creates Azure group which contains the network, VMs, network interfaces and security groups. This helps with an overview of used and available Azure resources.
 - [azure_networking](../azure_networking/README.md) role defines and manages the entire network stack: networks, sub-networks and security groups within the individual Azure group.
 - [azure_computing](../azure_computing/README.md) role defines and manages the VMs, their storage, network interfaces, public IPs and private IPs inside the individual Azure group.

## Defining variables

### Static inventory

The most important variables are in `static_inventory/[stack_name].yml`
 - `azure_flavor` - this one triggers the generation of VMs
 - `host_networks` - besides the `azure_flavor` this variables connects the VM to correct azure network

for example
 
```
      hosts:
        earl6:
          azure_flavor: Standard_DS1_v2
          host_networks:
            - name: "{{ stack_prefix }}_internal_management"
              security_group: "{{ stack_prefix }}_logservers"
              assign_floating_ip: true
```
without these two variables the `azure.yml` playbook will fail.

### Group variables

Following variables must be also defined in the `group_vars/[stack_name]/vars.yml`

 - `azure_networks` - must match the `host_networks` name from the `static_inventory/[stack_name].yml`
 - `azure_image` - most of the time we use the same image for longer time, so if you are not sure, it's best to copy paste from another group
 - (not urgent) `azure_resource_group` is by default already assigned to "{{ stack_name }}", therefore there is no need to define it here, but it could be changed

for example

```
azure_networks:
  - name: "{{ stack_prefix }}_internal_management"
    external: false
    cidr: '10.10.1.0/24'
    type: management
azure_image:
  rocky9:
    offer: 'rockylinux-x86_64'
    publisher: 'resf'
    sku: '9-base'
    version: 'latest'
azure_resource_group: "{{ stack_name }}"
```

Where

 - `azure_resource_group` defines an Azure group
 - `azure_networks` defines one or more networks of the current azure environment (does not support MTUs)
 - `azure_image` is a bit tricky, since user must find (preferably via azure cli) all four fields of this variable

## Login to the Azure via CLI

```
    (logs) 13:02:44 league-of-robots [130]$ az login
    A web browser has been opened at https://login.microsoftonline.com/organizations/oauth2/v2.0/authorize. Please continue the login in the web browser. If no web browser is available or if the web browser fails to open, use device code flow with `az login --use-device-code`.
```
the browser opens where you need to login to the Azure, after which you can close the tab and return back to command line:

```
    ... (after closing browser) ...
    Retrieving tenants and subscriptions for the selection...
    The following tenants don't contain accessible subscriptions. Use `az login --allow-no-subscriptions` to have tenant level access.
    4bdee30a-0c94-4865-bc52-1d9f894a4975 'Health-RI'
    
    [Tenant and subscription selection]
    
    No     Subscription name       Subscription ID                       Tenant
    -----  ----------------------  ------------------------------------  --------
    [1]    umcg-ccs-p              b2f52196-7d6e-4dc5-bc6e-6ee31c4c5c6b  UMCG
    [2] *  umcg-medgen-diag-p-ext  9f879778-5dff-451f-8cac-7a693c389b13  UMCG
    [3]    umcg-medgen-t           0913ca65-7232-4ae7-9538-113f112fe50e  UMCG
    
    The default is marked with an *; the default tenant is 'UMCG' and subscription is 'umcg-medgen-diag-p-ext' (9f879778-5dff-451f-8cac-7a693c389b13).
    
    Select a subscription and tenant (Type a number or Enter for no changes): 
```
you can simply press enter (if you wish to use the "public" Azure environment), as it is set as default by the 

`.azure/azureProfile.json`.

## Running playbooks

Now that you have loged in, you can deploy virtual machines.

After you have defined all the variables, you can (make sure you have initialized `lor-init` and done `lor-config`) simply run

```
    ansible-playbook azure.yml
```

The playbook should create the entire stack (network, VMs, network interfaces, security groups) and generate the the `group_vars/[stack_name]/` files

 - `ip_addresses.yml.new`, and
 - `ssh_client_settings.yml.new`

Make sure you don't overwrite the values of openstack generated or manually generated IPs! Keep/update only the values that were generated by Ansible Azure roles of `azure_general`, `azure_compute` and `azure_network`.

## Instances physical location

The default `azure_location` is set to `westeurope`, which does not need to be changed - ever. It is defined in

 - `.azure/config`,
 - `group_vars/all/vars.yml`, as well as in
 - `defaults/main.yml` of all three roles: `azure_general`, `azure_networking` and `azure_computing`

## Extra information

https://docs.ansible.com/ansible/4/scenario_guides/guide_azure.html

