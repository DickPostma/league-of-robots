---
- name: Installing postgresql-server
  become: true
  yum:
    name: postgresql-server
    state: latest

- name: Installing python-psycopg2
  become: true
  yum:
    name: python-psycopg2
    state: latest

- name: Initializing PGSQL database
  become: true
  command: "/usr/bin/postgresql-setup initdb"
  args:
    creates: /var/lib/pgsql/data/pg_hba.conf

- name: Fixing pg_hba.conf to permit ipv4localhost password authentication
  become: true
  lineinfile:
    name: /var/lib/pgsql/data/pg_hba.conf
    regexp: "host    all             all             127.0.0.1/32            ident"
    line: "host    all             all             127.0.0.1/32            md5"
    backrefs: true
  register: fixipv4

- name: Fixing pg_hba.conf to permit ipv6 localhost password authentication
  become: true
  lineinfile:
    name: /var/lib/pgsql/data/pg_hba.conf
    regexp: "host    all             all             ::1/128                 ident"
    line: "host    all             all             ::1/128                 md5"
    backrefs: true
  register: fixipv6

- name: Restarting PGSQL and making sure it is enabled
  ansible.builtin.systemd:
    name: postgresql
    state: restarted
    enabled: true
  when: fixipv4.changed and fixipv6.changed
  become: true
